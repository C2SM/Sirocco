---
# Include external CI template from CSCS
include:
  - remote: "https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml"

# Defines the stages for the CI/CD pipeline
# Jobs in earlier stages are run before jobs in later stages.
stages:
  - build

variables:
  TMPDIR: "/var/tmp"

job:
  stage: build
  extends: .f7t-controller
  script:
    - FIRECREST_URL=https://api.cscs.ch/cw/firecrest/v1
    - FIRECREST_SYSTEM=santis
    - FIRECREST_API_VERSION=1.16.0
    - touch file
    - firecrest rm /capstor/scratch/cscs/agoscins/sirocco-tests
    - firecrest mkdir /capstor/scratch/cscs/agoscins/sirocco-tests
    - firecrest upload tests/cases/small-icon/config/config.yml /capstor/scratch/cscs/agoscins/sirocco-tests config.yml
    - firecrest filesystems 
    - firecrest filesystems -s santis
    - firecrest filesystems --system $FIRECREST_SYSTEM
    #- mkdir /tmp/sirocco || true
    #- apt-get update -y && apt-get install -y --no-install-recommends graphviz graphviz-dev rabbitmq-server
    #- pip install --upgrade pip
    #- pip install . 
    #- whoami
    #- echo $SCRATCH
    #- echo $PWD
    #- echo $HOME
    #- firecrest --help
    #- firecrest --help
    #- firecrest upload --help
    - firecrest id --system $FIRECREST_SYSTEM
    - firecrest filesystems --system $FIRECREST_SYSTEM
    - firecrest get-partitions --system $FIRECREST_SYSTEM
    - firecrest get-reservations --system $FIRECREST_SYSTEM
    - firecrest ls / --system $FIRECREST_SYSTEM
    - firecrest ls --system $FIRECREST_SYSTEM /
    - firecrest ls --system $FIRECREST_SYSTEM /capstor
    - firecrest ls --system $FIRECREST_SYSTEM /capstor/scratch
    - verdi presto --profile-name "cscs-ci"
    - verdi computer setup --label localhost_ssh --hostname unused --transport firecrest --scheduler firecrest -n 
    - verdi devel launch-add # hacky way to define localhost TODO do properly
    - verdi computer configure firecrest localhost_ssh --url $FIRECREST_URL --token-uri https://auth.cscs.ch/auth/realms/firecrest-clients/protocol/openid-connect/token --client-id $FIRECREST_CLIENT_ID --client-secret $FIRECREST_CLIENT_SECRET --compute-resource $CLUSTER --temp-directory /tmp/sirocco --api-version 1.16.0 --small-file-size-mb 4096 # TODO rename localhost_ssh in config file to remote and pytest provdie a way to pass the remote
    - verdi computer test localhost_ssh 
    - python ci/preparerun.py
